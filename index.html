<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trader Game 04</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #4ec9b0;
            margin-bottom: 20px;
        }

        .controls {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .control-row {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background-color: #0e639c;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }

        button:hover {
            background-color: #1177bb;
        }

        button:active {
            background-color: #0d5689;
        }

        button.secondary {
            background-color: #3e3e42;
        }

        button.secondary:hover {
            background-color: #4e4e52;
        }

        .output {
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
            min-height: 400px;
            overflow-y: auto;
            max-height: 600px;
        }

        .facilities-info {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            white-space: pre-wrap;
            font-size: 12px;
        }

        .market-display {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            white-space: pre-wrap;
            font-size: 14px;
        }

        .company-panel {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .company-header {
            color: #4ec9b0;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .balance {
            color: #ce9178;
            font-size: 16px;
        }

        .facility-list {
            margin-top: 10px;
        }

        .facility-item {
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .facility-name {
            color: #9cdcfe;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .facility-status {
            color: #d4d4d4;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .facility-inventory {
            color: #ce9178;
            font-size: 12px;
        }

        label {
            color: #9cdcfe;
            margin-right: 10px;
        }

        select, input {
            background-color: #3c3c3c;
            color: #d4d4d4;
            border: 1px solid #3e3e42;
            padding: 5px 10px;
            border-radius: 3px;
            font-family: inherit;
        }

        .section-title {
            color: #4ec9b0;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .message-log {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 13px;
        }

        .message {
            padding: 5px 0;
            border-bottom: 1px solid #3e3e42;
        }

        .message:last-child {
            border-bottom: none;
        }

        .message.success {
            color: #4ec9b0;
        }

        .message.error {
            color: #f48771;
        }

        .message.info {
            color: #9cdcfe;
        }

        .action-form {
            display: none;
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 10px;
            margin-top: 10px;
            border-radius: 3px;
        }

        .action-form.active {
            display: block;
        }

        .form-row {
            margin-bottom: 10px;
        }

        .form-row label {
            display: inline-block;
            width: 120px;
        }

        .form-row input,
        .form-row select {
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Trader Game 04</h1>
        
        <div class="facilities-info" id="facilitiesInfo"></div>
        <div class="facilities-info" id="resourcesInfo"></div>
        <div class="facilities-info" id="citiesInfo"></div>
        
        <div class="message-log" id="messageLog">
            <div class="message info">Game initialized. Ready to play!</div>
        </div>
        
        <div class="controls">
            <div class="section-title">Game Controls</div>
            <div class="control-row">
                <button onclick="processTick()">‚è≠Ô∏è Process Tick</button>
                <button onclick="autoTick()" id="autoTickBtn">‚ñ∂Ô∏è Auto Tick (1s)</button>
                <button onclick="resetGame()" class="secondary">üîÑ Reset Game</button>
            </div>
        </div>

        <div class="company-panel">
            <div class="company-header">
                <span>üë©‚Äçüíº Alice Corp</span>
                <span class="balance" id="aliceBalance">$10,000.00</span>
            </div>
            <div class="facility-list" id="aliceFacilities"></div>
        </div>

        <div class="controls">
            <div class="section-title">Alice Corp Actions</div>
            <div class="control-row">
                <label>Facility Type:</label>
                <select id="aliceFacilityType">
                    <option value="farm">Farm ($1000)</option>
                    <option value="mill">Mill ($1500)</option>
                    <option value="bakery">Bakery ($2000)</option>
                    <option value="warehouse">Warehouse ($500)</option>
                </select>
                <label>City:</label>
                <select id="aliceFacilityCity">
                    <option value="Copenhagen,Denmark">Copenhagen (Denmark, wealth 0.9)</option>
                    <option value="Aarhus,Denmark">Aarhus (Denmark, wealth 0.85)</option>
                    <option value="Prague,Czech Republic">Prague (Czech Republic, wealth 0.3)</option>
                    <option value="Cairo,Egypt">Cairo (Egypt, wealth 0.1)</option>
                </select>
                <button onclick="createFacility('alice')">Build Facility</button>
            </div>
            <div class="control-row">
                <button onclick="toggleForm('aliceTransfer')">Transfer Resources</button>
                <button onclick="toggleForm('aliceSellOffer')">Create Sell Offer</button>
                <button onclick="toggleForm('aliceContract')">Create Buy Contract</button>
                <button onclick="toggleForm('aliceUpgrade')">Upgrade Facility</button>
                <button onclick="toggleForm('aliceWorkers')">Hire/Fire Workers</button>
                <button onclick="toggleForm('aliceEdit')">Edit Offer/Contract</button>
                <button onclick="toggleForm('aliceCancel')">Cancel Offer/Contract</button>
            </div>
            
            <div id="aliceTransfer" class="action-form">
                <div class="form-row">
                    <label>From Facility:</label>
                    <select id="aliceTransferFrom"></select>
                </div>
                <div class="form-row">
                    <label>To Facility:</label>
                    <select id="aliceTransferTo"></select>
                </div>
                <div class="form-row">
                    <label>Resource:</label>
                    <select id="aliceTransferResource"></select>
                </div>
                <div class="form-row">
                    <label>Amount:</label>
                    <input type="number" id="aliceTransferAmount" min="1" value="1">
                </div>
                <button onclick="executeTransfer('alice')">Execute Transfer</button>
                <button onclick="toggleForm('aliceTransfer')" class="secondary">Cancel</button>
            </div>
            
            <div id="aliceUpgrade" class="action-form">
                <div class="form-row">
                    <label>Select Facility:</label>
                    <select id="aliceUpgradeFacility"></select>
                </div>
                <div id="aliceUpgradeInfo" style="margin: 10px 0; color: #9cdcfe; font-size: 12px;"></div>
                <button onclick="executeUpgrade('alice')">Upgrade Facility</button>
                <button onclick="toggleForm('aliceUpgrade')" class="secondary">Cancel</button>
            </div>
            
            <div id="aliceWorkers" class="action-form">
                <div class="form-row">
                    <label>Select Facility:</label>
                    <select id="aliceWorkersFacility" onchange="updateWorkersSlider('alice')"></select>
                </div>
                <div id="aliceWorkersInfo" style="margin: 10px 0; color: #9cdcfe; font-size: 12px;"></div>
                <div class="form-row">
                    <label>Workers: <span id="aliceWorkersValue">0</span></label>
                    <input type="range" id="aliceWorkersSlider" min="1" max="10" value="1" oninput="updateWorkersDisplay('alice')">
                </div>
                <button onclick="executeSetWorkers('alice')">Set Worker Count</button>
                <button onclick="toggleForm('aliceWorkers')" class="secondary">Cancel</button>
            </div>
            
            <div id="aliceSellOffer" class="action-form">
                <div class="form-row">
                    <label>From Facility:</label>
                    <select id="aliceSellOfferFacility"></select>
                </div>
                <div class="form-row">
                    <label>Resource:</label>
                    <select id="aliceSellOfferResource"></select>
                </div>
                <div class="form-row">
                    <label>Amount/tick:</label>
                    <input type="number" id="aliceSellOfferAmount" min="1" value="1">
                </div>
                <div class="form-row">
                    <label>Price per Unit:</label>
                    <input type="number" id="aliceSellOfferPrice" min="0.01" step="0.01" value="1.00">
                </div>
                <button onclick="executeCreateSellOffer('alice')">Create Sell Offer</button>
                <button onclick="toggleForm('aliceSellOffer')" class="secondary">Cancel</button>
            </div>
            
            <div id="aliceContract" class="action-form">
                <div class="form-row">
                    <label>Sell Offer:</label>
                    <select id="aliceContractOffer"></select>
                </div>
                <div class="form-row">
                    <label>To Facility:</label>
                    <select id="aliceContractFacility"></select>
                </div>
                <div class="form-row">
                    <label>Amount/tick:</label>
                    <input type="number" id="aliceContractAmount" min="1" value="1">
                </div>
                <button onclick="executeCreateContract('alice')">Create Contract</button>
                <button onclick="toggleForm('aliceContract')" class="secondary">Cancel</button>
            </div>
            
            <div id="aliceEdit" class="action-form">
                <div class="form-row">
                    <label>Type:</label>
                    <select id="aliceEditType" onchange="updateEditOptions('alice')">
                        <option value="offer">My Sell Offer</option>
                        <option value="contract-seller">My Contract (Selling)</option>
                        <option value="contract-buyer">My Contract (Buying)</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Select:</label>
                    <select id="aliceEditSelect" onchange="populateEditForm('alice')"></select>
                </div>
                <div id="aliceEditOfferForm" style="display: none;">
                    <div class="form-row">
                        <label>New Price/unit:</label>
                        <input type="number" id="aliceEditOfferPrice" min="0.01" step="0.01" value="1.00">
                    </div>
                    <div class="form-row">
                        <label>New Amount/tick:</label>
                        <input type="number" id="aliceEditOfferAmount" min="1" value="1">
                    </div>
                    <button onclick="executeEditOffer('alice')">Update Offer</button>
                </div>
                <div id="aliceEditContractSellerForm" style="display: none;">
                    <div class="form-row">
                        <label>New Price/unit:</label>
                        <input type="number" id="aliceEditContractSellerPrice" min="0.01" step="0.01" value="1.00">
                    </div>
                    <button onclick="executeEditContractSeller('alice')">Update Price</button>
                </div>
                <div id="aliceEditContractBuyerForm" style="display: none;">
                    <div class="form-row">
                        <label>New Amount/tick:</label>
                        <input type="number" id="aliceEditContractBuyerAmount" min="1" value="1">
                    </div>
                    <button onclick="executeEditContractBuyer('alice')">Update Amount</button>
                </div>
                <button onclick="toggleForm('aliceEdit')" class="secondary">Close</button>
            </div>
            
            <div id="aliceCancel" class="action-form">
                <div class="form-row">
                    <label>Type:</label>
                    <select id="aliceCancelType" onchange="updateCancelOptions('alice')">
                        <option value="offer">Sell Offer</option>
                        <option value="contract">Contract</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Select:</label>
                    <select id="aliceCancelSelect"></select>
                </div>
                <button onclick="executeCancel('alice')">Cancel</button>
                <button onclick="toggleForm('aliceCancel')" class="secondary">Close</button>
            </div>
        </div>

        <div class="company-panel">
            <div class="company-header">
                <span>üè≠ Bob Industries</span>
                <span class="balance" id="bobBalance">$10,000.00</span>
            </div>
            <div class="facility-list" id="bobFacilities"></div>
        </div>

        <div class="controls">
            <div class="section-title">Bob Industries Actions</div>
            <div class="control-row">
                <label>Facility Type:</label>
                <select id="bobFacilityType">
                    <option value="farm">Farm ($1000)</option>
                    <option value="mill">Mill ($1500)</option>
                    <option value="bakery">Bakery ($2000)</option>
                    <option value="warehouse">Warehouse ($500)</option>
                </select>
                <label>City:</label>
                <select id="bobFacilityCity">
                    <option value="Copenhagen,Denmark">Copenhagen (Denmark, wealth 0.9)</option>
                    <option value="Aarhus,Denmark">Aarhus (Denmark, wealth 0.85)</option>
                    <option value="Prague,Czech Republic">Prague (Czech Republic, wealth 0.3)</option>
                    <option value="Cairo,Egypt">Cairo (Egypt, wealth 0.1)</option>
                </select>
                <button onclick="createFacility('bob')">Build Facility</button>
            </div>
            <div class="control-row">
                <button onclick="toggleForm('bobTransfer')">Transfer Resources</button>
                <button onclick="toggleForm('bobSellOffer')">Create Sell Offer</button>
                <button onclick="toggleForm('bobContract')">Create Buy Contract</button>
                <button onclick="toggleForm('bobUpgrade')">Upgrade Facility</button>
                <button onclick="toggleForm('bobWorkers')">Hire/Fire Workers</button>
                <button onclick="toggleForm('bobEdit')">Edit Offer/Contract</button>
                <button onclick="toggleForm('bobCancel')">Cancel Offer/Contract</button>
            </div>
            
            <div id="bobTransfer" class="action-form">
                <div class="form-row">
                    <label>From Facility:</label>
                    <select id="bobTransferFrom"></select>
                </div>
                <div class="form-row">
                    <label>To Facility:</label>
                    <select id="bobTransferTo"></select>
                </div>
                <div class="form-row">
                    <label>Resource:</label>
                    <select id="bobTransferResource"></select>
                </div>
                <div class="form-row">
                    <label>Amount:</label>
                    <input type="number" id="bobTransferAmount" min="1" value="1">
                </div>
                <button onclick="executeTransfer('bob')">Execute Transfer</button>
                <button onclick="toggleForm('bobTransfer')" class="secondary">Cancel</button>
            </div>
            
            <div id="bobUpgrade" class="action-form">
                <div class="form-row">
                    <label>Select Facility:</label>
                    <select id="bobUpgradeFacility"></select>
                </div>
                <div id="bobUpgradeInfo" style="margin: 10px 0; color: #9cdcfe; font-size: 12px;"></div>
                <button onclick="executeUpgrade('bob')">Upgrade Facility</button>
                <button onclick="toggleForm('bobUpgrade')" class="secondary">Cancel</button>
            </div>
            
            <div id="bobWorkers" class="action-form">
                <div class="form-row">
                    <label>Select Facility:</label>
                    <select id="bobWorkersFacility" onchange="updateWorkersSlider('bob')"></select>
                </div>
                <div id="bobWorkersInfo" style="margin: 10px 0; color: #9cdcfe; font-size: 12px;"></div>
                <div class="form-row">
                    <label>Workers: <span id="bobWorkersValue">0</span></label>
                    <input type="range" id="bobWorkersSlider" min="1" max="10" value="1" oninput="updateWorkersDisplay('bob')">
                </div>
                <button onclick="executeSetWorkers('bob')">Set Worker Count</button>
                <button onclick="toggleForm('bobWorkers')" class="secondary">Cancel</button>
            </div>
            
            <div id="bobSellOffer" class="action-form">
                <div class="form-row">
                    <label>From Facility:</label>
                    <select id="bobSellOfferFacility"></select>
                </div>
                <div class="form-row">
                    <label>Resource:</label>
                    <select id="bobSellOfferResource"></select>
                </div>
                <div class="form-row">
                    <label>Amount/tick:</label>
                    <input type="number" id="bobSellOfferAmount" min="1" value="1">
                </div>
                <div class="form-row">
                    <label>Price per Unit:</label>
                    <input type="number" id="bobSellOfferPrice" min="0.01" step="0.01" value="1.00">
                </div>
                <button onclick="executeCreateSellOffer('bob')">Create Sell Offer</button>
                <button onclick="toggleForm('bobSellOffer')" class="secondary">Cancel</button>
            </div>
            
            <div id="bobContract" class="action-form">
                <div class="form-row">
                    <label>Sell Offer:</label>
                    <select id="bobContractOffer"></select>
                </div>
                <div class="form-row">
                    <label>To Facility:</label>
                    <select id="bobContractFacility"></select>
                </div>
                <div class="form-row">
                    <label>Amount/tick:</label>
                    <input type="number" id="bobContractAmount" min="1" value="1">
                </div>
                <button onclick="executeCreateContract('bob')">Create Contract</button>
                <button onclick="toggleForm('bobContract')" class="secondary">Cancel</button>
            </div>
            
            <div id="bobEdit" class="action-form">
                <div class="form-row">
                    <label>Type:</label>
                    <select id="bobEditType" onchange="updateEditOptions('bob')">
                        <option value="offer">My Sell Offer</option>
                        <option value="contract-seller">My Contract (Selling)</option>
                        <option value="contract-buyer">My Contract (Buying)</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Select:</label>
                    <select id="bobEditSelect" onchange="populateEditForm('bob')"></select>
                </div>
                <div id="bobEditOfferForm" style="display: none;">
                    <div class="form-row">
                        <label>New Price/unit:</label>
                        <input type="number" id="bobEditOfferPrice" min="0.01" step="0.01" value="1.00">
                    </div>
                    <div class="form-row">
                        <label>New Amount/tick:</label>
                        <input type="number" id="bobEditOfferAmount" min="1" value="1">
                    </div>
                    <button onclick="executeEditOffer('bob')">Update Offer</button>
                </div>
                <div id="bobEditContractSellerForm" style="display: none;">
                    <div class="form-row">
                        <label>New Price/unit:</label>
                        <input type="number" id="bobEditContractSellerPrice" min="0.01" step="0.01" value="1.00">
                    </div>
                    <button onclick="executeEditContractSeller('bob')">Update Price</button>
                </div>
                <div id="bobEditContractBuyerForm" style="display: none;">
                    <div class="form-row">
                        <label>New Amount/tick:</label>
                        <input type="number" id="bobEditContractBuyerAmount" min="1" value="1">
                    </div>
                    <button onclick="executeEditContractBuyer('bob')">Update Amount</button>
                </div>
                <button onclick="toggleForm('bobEdit')" class="secondary">Close</button>
            </div>
            
            <div id="bobCancel" class="action-form">
                <div class="form-row">
                    <label>Type:</label>
                    <select id="bobCancelType" onchange="updateCancelOptions('bob')">
                        <option value="offer">Sell Offer</option>
                        <option value="contract">Contract</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Select:</label>
                    <select id="bobCancelSelect"></select>
                </div>
                <button onclick="executeCancel('bob')">Cancel</button>
                <button onclick="toggleForm('bobCancel')" class="secondary">Close</button>
            </div>
        </div>

        <div class="market-display" id="marketDisplay"></div>

        <div class="output" id="output">Tick 0</div>
    </div>

    <script type="module">
        import { GameEngine } from './dist/game/GameEngine.js';
        import { FacilityRegistry } from './dist/game/FacilityRegistry.js';
        import { ResourceRegistry } from './dist/game/ResourceRegistry.js';
        import { CityRegistry } from './dist/game/CityRegistry.js';

        // Initialize game
        let game = new GameEngine();
        let alice = game.addCompany('alice', 'Alice Corp');
        let bob = game.addCompany('bob', 'Bob Industries');
        let autoTickInterval = null;

        // Make functions globally available
        window.game = game;
        window.alice = alice;
        window.bob = bob;

        function addMessage(text, type = 'info') {
            const log = document.getElementById('messageLog');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            log.appendChild(message);
            log.scrollTop = log.scrollHeight;
            
            // Keep only last 20 messages
            while (log.children.length > 20) {
                log.removeChild(log.firstChild);
            }
        }

        window.toggleForm = function(formId) {
            const form = document.getElementById(formId);
            const isActive = form.classList.contains('active');
            
            // Close all forms
            document.querySelectorAll('.action-form').forEach(f => f.classList.remove('active'));
            
            // Toggle this form
            if (!isActive) {
                form.classList.add('active');
                updateFormOptions(formId);
            }
        };

        function updateFormOptions(formId) {
            const company = formId.startsWith('alice') ? alice : bob;
            const companyId = formId.startsWith('alice') ? 'alice' : 'bob';
            
            // Update facility dropdowns
            if (formId.includes('Transfer')) {
                updateFacilityDropdowns(`${companyId}TransferFrom`, company);
                updateFacilityDropdowns(`${companyId}TransferTo`, company);
                updateResourceDropdowns(`${companyId}TransferResource`);
            } else if (formId.includes('Upgrade')) {
                updateUpgradeFacilityDropdown(companyId, company);
            } else if (formId.includes('Workers')) {
                updateWorkersFacilityDropdown(companyId, company);
            } else if (formId.includes('SellOffer')) {
                updateFacilityDropdowns(`${companyId}SellOfferFacility`, company);
                updateResourceDropdowns(`${companyId}SellOfferResource`);
            } else if (formId.includes('Contract')) {
                updateFacilityDropdowns(`${companyId}ContractFacility`, company);
                updateSellOffers(`${companyId}ContractOffer`);
            } else if (formId.includes('Edit')) {
                updateEditOptions(companyId);
            } else if (formId.includes('Cancel')) {
                updateCancelOptions(companyId);
            }
        }

        function updateResourceDropdowns(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            
            const resources = ResourceRegistry.getAll();
            resources.forEach(resource => {
                const option = document.createElement('option');
                option.value = resource.id;
                option.textContent = `${resource.icon} ${resource.name}`;
                select.appendChild(option);
            });
        }

        function updateFacilityDropdowns(selectId, company) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            
            if (company.facilities.length === 0) {
                select.innerHTML = '<option value="">No facilities</option>';
                return;
            }
            
            company.facilities.forEach((facility, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Facility ${index + 1} (${facility.type})`;
                select.appendChild(option);
            });
        }

        function updateUpgradeFacilityDropdown(companyId, company) {
            const select = document.getElementById(`${companyId}UpgradeFacility`);
            const infoDiv = document.getElementById(`${companyId}UpgradeInfo`);
            select.innerHTML = '';
            infoDiv.textContent = '';
            
            if (company.facilities.length === 0) {
                select.innerHTML = '<option value="">No facilities</option>';
                return;
            }
            
            company.facilities.forEach((facility, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${facility.name} (Size ${facility.size})`;
                select.appendChild(option);
            });
            
            // Add change listener to show upgrade info
            select.onchange = function() {
                const index = parseInt(select.value);
                const facility = company.facilities[index];
                if (facility) {
                    const cost = facility.getUpgradeCost();
                    const newSize = facility.size + 1;
                    const currentRequired = facility.calculateRequiredWorkers();
                    const newRequired = Math.ceil(FacilityRegistry.get(facility.type).workerMultiplier * Math.pow(newSize, 1.2));
                    const newMultiplier = Math.sqrt(newSize);
                    infoDiv.textContent = `Upgrade to Size ${newSize}: Cost $${cost.toFixed(2)} | Required Workers ${currentRequired}‚Üí${newRequired} | Output ${facility.getProductionMultiplier().toFixed(2)}x‚Üí${newMultiplier.toFixed(2)}x`;
                }
            };
            
            // Trigger initial display
            select.onchange();
        }

        function updateWorkersFacilityDropdown(companyId, company) {
            const select = document.getElementById(`${companyId}WorkersFacility`);
            select.innerHTML = '';
            
            if (company.facilities.length === 0) {
                select.innerHTML = '<option value="">No facilities</option>';
                return;
            }
            
            company.facilities.forEach((facility, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${facility.name} (${facility.workers} workers)`;
                select.appendChild(option);
            });
            
            // Trigger initial slider update
            updateWorkersSlider(companyId);
        }

        function updateSellOffers(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            
            const offers = game.getMarket().getAvailableSellOffers();
            
            if (offers.length === 0) {
                select.innerHTML = '<option value="">No sell offers</option>';
                return;
            }
            
            offers.forEach(offer => {
                const option = document.createElement('option');
                option.value = offer.id;
                const resourceDef = ResourceRegistry.get(offer.resource);
                const icon = resourceDef ? resourceDef.icon + ' ' : '';
                option.textContent = `${icon}${offer.resource}: ${offer.amountInStock}/tick available (${offer.amountAvailable} listed) @ $${offer.pricePerUnit.toFixed(2)} (${offer.sellerName})`;
                select.appendChild(option);
            });
        }
        
        window.updateCancelOptions = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            const type = document.getElementById(`${companyId}CancelType`).value;
            const select = document.getElementById(`${companyId}CancelSelect`);
            select.innerHTML = '';
            
            if (type === 'offer') {
                const offers = game.getMarket().getAllSellOffers().filter(o => o.sellerId === company.id);
                if (offers.length === 0) {
                    select.innerHTML = '<option value="">No offers to cancel</option>';
                    return;
                }
                offers.forEach(offer => {
                    const option = document.createElement('option');
                    option.value = offer.id;
                    const resourceDef = ResourceRegistry.get(offer.resource);
                    const icon = resourceDef ? resourceDef.icon + ' ' : '';
                    option.textContent = `${icon}${offer.resource}: ${offer.amountInStock}/tick available @ $${offer.pricePerUnit.toFixed(2)}/unit`;
                    select.appendChild(option);
                });
            } else {
                const contracts = game.getMarket().getAllContracts().filter(c => 
                    c.buyerId === company.id || c.sellerId === company.id
                );
                if (contracts.length === 0) {
                    select.innerHTML = '<option value="">No contracts to cancel</option>';
                    return;
                }
                contracts.forEach(contract => {
                    const option = document.createElement('option');
                    option.value = contract.id;
                    const resourceDef = ResourceRegistry.get(contract.resource);
                    const icon = resourceDef ? resourceDef.icon + ' ' : '';
                    const role = contract.sellerId === company.id ? '(Selling)' : '(Buying)';
                    const otherParty = contract.sellerId === company.id ? contract.buyerName : contract.sellerName;
                    const status = contract.lastFailedTick !== null ? '[FAILED]' : '';
                    option.textContent = `${icon}${contract.resource} ${contract.amountPerTick}/tick @ $${contract.pricePerUnit.toFixed(2)} ${role} with ${otherParty} ${status}`;
                    select.appendChild(option);
                });
            }
        };
        
        window.updateEditOptions = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            const type = document.getElementById(`${companyId}EditType`).value;
            const select = document.getElementById(`${companyId}EditSelect`);
            select.innerHTML = '';
            
            // Hide all forms
            document.getElementById(`${companyId}EditOfferForm`).style.display = 'none';
            document.getElementById(`${companyId}EditContractSellerForm`).style.display = 'none';
            document.getElementById(`${companyId}EditContractBuyerForm`).style.display = 'none';
            
            if (type === 'offer') {
                const offers = game.getMarket().getAllSellOffers().filter(o => o.sellerId === company.id);
                if (offers.length === 0) {
                    select.innerHTML = '<option value="">No offers to edit</option>';
                    return;
                }
                offers.forEach(offer => {
                    const option = document.createElement('option');
                    option.value = offer.id;
                    const resourceDef = ResourceRegistry.get(offer.resource);
                    const icon = resourceDef ? resourceDef.icon + ' ' : '';
                    option.textContent = `${icon}${offer.resource}: ${offer.amountAvailable}/tick @ $${offer.pricePerUnit.toFixed(2)}`;
                    select.appendChild(option);
                });
            } else if (type === 'contract-seller') {
                const contracts = game.getMarket().getAllContracts().filter(c => c.sellerId === company.id);
                if (contracts.length === 0) {
                    select.innerHTML = '<option value="">No selling contracts to edit</option>';
                    return;
                }
                contracts.forEach(contract => {
                    const option = document.createElement('option');
                    option.value = contract.id;
                    const resourceDef = ResourceRegistry.get(contract.resource);
                    const icon = resourceDef ? resourceDef.icon + ' ' : '';
                    option.textContent = `${icon}${contract.resource}: ${contract.amountPerTick}/tick @ $${contract.pricePerUnit.toFixed(2)} to ${contract.buyerName}`;
                    select.appendChild(option);
                });
            } else if (type === 'contract-buyer') {
                const contracts = game.getMarket().getAllContracts().filter(c => c.buyerId === company.id);
                if (contracts.length === 0) {
                    select.innerHTML = '<option value="">No buying contracts to edit</option>';
                    return;
                }
                contracts.forEach(contract => {
                    const option = document.createElement('option');
                    option.value = contract.id;
                    const resourceDef = ResourceRegistry.get(contract.resource);
                    const icon = resourceDef ? resourceDef.icon + ' ' : '';
                    option.textContent = `${icon}${contract.resource}: ${contract.amountPerTick}/tick @ $${contract.pricePerUnit.toFixed(2)} from ${contract.sellerName}`;
                    select.appendChild(option);
                });
            }
            
            populateEditForm(companyId);
        };
        
        window.populateEditForm = function(companyId) {
            const type = document.getElementById(`${companyId}EditType`).value;
            const id = document.getElementById(`${companyId}EditSelect`).value;
            
            if (!id) return;
            
            if (type === 'offer') {
                const offer = game.getMarket().getSellOffer(id);
                if (offer) {
                    document.getElementById(`${companyId}EditOfferPrice`).value = offer.pricePerUnit;
                    document.getElementById(`${companyId}EditOfferAmount`).value = offer.amountAvailable;
                    document.getElementById(`${companyId}EditOfferForm`).style.display = 'block';
                }
            } else if (type === 'contract-seller') {
                const contract = game.getMarket().getContract(id);
                if (contract) {
                    document.getElementById(`${companyId}EditContractSellerPrice`).value = contract.pricePerUnit;
                    document.getElementById(`${companyId}EditContractSellerForm`).style.display = 'block';
                }
            } else if (type === 'contract-buyer') {
                const contract = game.getMarket().getContract(id);
                if (contract) {
                    document.getElementById(`${companyId}EditContractBuyerAmount`).value = contract.amountPerTick;
                    document.getElementById(`${companyId}EditContractBuyerForm`).style.display = 'block';
                }
            }
        };

        function updateDisplay() {
            // Update tick counter
            const output = document.getElementById('output');
            output.textContent = `Tick ${game.getTickCount()}`;
            
            // Update market display with sell offers and contracts
            const marketDisplay = document.getElementById('marketDisplay');
            const market = game.getMarket();
            
            let marketHtml = market.displayMarket();
            marketDisplay.textContent = marketHtml;
            
            // Update Alice's info
            updateCompanyDisplay(alice, 'alice');
            
            // Update Bob's info
            updateCompanyDisplay(bob, 'bob');
        }

        function updateCompanyDisplay(company, companyId) {
            // Update balance
            document.getElementById(`${companyId}Balance`).textContent = 
                `$${company.balance.toFixed(2)}`;
            
            // Update facilities
            const facilitiesDiv = document.getElementById(`${companyId}Facilities`);
            
            if (company.facilities.length === 0) {
                facilitiesDiv.innerHTML = '<div style="color: #666; font-style: italic;">No facilities</div>';
                return;
            }
            
            let html = '';
            company.facilities.forEach((facility, index) => {
                // Get facility size, workers, and output multiplier
                const sizeInfo = `Size: ${facility.size} | Workers: ${facility.workers} | Output: ${facility.getProductionMultiplier().toFixed(2)}x`;
                
                // Get facility status
                const statusStr = facility.isProducing 
                    ? `Producing (${facility.productionProgress}/${facility.recipe?.ticksRequired || 0})` 
                    : 'Idle';
                
                // Get recipe name
                const recipeName = facility.recipe ? facility.recipe.name : 'No recipe';
                
                // Get inventory with emojis
                const inventoryItems = Array.from(facility.inventory.entries())
                    .filter(([_, amount]) => amount > 0)
                    .map(([resource, amount]) => {
                        const resourceDef = ResourceRegistry.get(resource);
                        const icon = resourceDef ? resourceDef.icon + ' ' : '';
                        return `${icon}${resource}: ${amount}`;
                    })
                    .join('<br>          ');
                const inventoryStr = inventoryItems || 'empty';
                
                // Get contracts info
                const sellingContracts = facility.getSellingContracts();
                const buyingContracts = facility.getBuyingContracts();
                let contractsHtml = '';
                
                if (sellingContracts.length > 0) {
                    contractsHtml += '<br>        <span style="color: #4ec9b0;">Selling:</span><br>          ';
                    contractsHtml += sellingContracts.map(c => {
                        const resourceDef = ResourceRegistry.get(c.resource);
                        const icon = resourceDef ? resourceDef.icon + ' ' : '';
                        const contract = game.getMarket().getContract(c.contractId);
                        const status = contract && contract.lastFailedTick !== null ? ' [FAILED]' : '';
                        return `${icon}${c.resource}: ${c.amountPerTick}/tick @ $${c.pricePerUnit.toFixed(2)}${status}`;
                    }).join('<br>          ');
                }
                
                if (buyingContracts.length > 0) {
                    contractsHtml += '<br>        <span style="color: #ce9178;">Buying:</span><br>          ';
                    contractsHtml += buyingContracts.map(c => {
                        const resourceDef = ResourceRegistry.get(c.resource);
                        const icon = resourceDef ? resourceDef.icon + ' ' : '';
                        const contract = game.getMarket().getContract(c.contractId);
                        const status = contract && contract.lastFailedTick !== null ? ' [FAILED]' : '';
                        return `${icon}${c.resource}: ${c.amountPerTick}/tick @ $${c.pricePerUnit.toFixed(2)}${status}`;
                    }).join('<br>          ');
                }
                
                // Get flow information
                let flowHtml = '';
                
                // Imports
                const imports = facility.getImportRate();
                if (imports.size > 0) {
                    flowHtml += '<br>        <span style="color: #9cdcfe;">Import:</span> ';
                    const importParts = [];
                    imports.forEach((rate, resource) => {
                        const resourceDef = ResourceRegistry.get(resource);
                        const icon = resourceDef ? resourceDef.icon + ' ' : '';
                        importParts.push(`${icon}+${rate.toFixed(2)}/tick`);
                    });
                    flowHtml += importParts.join(', ');
                }
                
                // Exports
                const exports = facility.getExportRate();
                if (exports.size > 0) {
                    flowHtml += '<br>        <span style="color: #9cdcfe;">Export:</span> ';
                    const exportParts = [];
                    exports.forEach((rate, resource) => {
                        const resourceDef = ResourceRegistry.get(resource);
                        const icon = resourceDef ? resourceDef.icon + ' ' : '';
                        exportParts.push(`${icon}-${rate.toFixed(2)}/tick`);
                    });
                    flowHtml += exportParts.join(', ');
                }
                
                // Production
                const production = facility.getProductionRate();
                if (production.size > 0) {
                    flowHtml += '<br>        <span style="color: #4ec9b0;">Production:</span> ';
                    const prodParts = [];
                    production.forEach((rate, resource) => {
                        const resourceDef = ResourceRegistry.get(resource);
                        const icon = resourceDef ? resourceDef.icon + ' ' : '';
                        prodParts.push(`${icon}+${rate.toFixed(2)}/tick`);
                    });
                    flowHtml += prodParts.join(', ');
                }
                
                // Consumption
                const consumption = facility.getConsumptionRate();
                if (consumption.size > 0) {
                    flowHtml += '<br>        <span style="color: #f48771;">Consumption:</span> ';
                    const consParts = [];
                    consumption.forEach((rate, resource) => {
                        const resourceDef = ResourceRegistry.get(resource);
                        const icon = resourceDef ? resourceDef.icon + ' ' : '';
                        consParts.push(`${icon}-${rate.toFixed(2)}/tick`);
                    });
                    flowHtml += consParts.join(', ');
                }
                
                // Net flow
                const netFlow = facility.getNetFlow();
                if (netFlow.size > 0) {
                    flowHtml += '<br>        <span style="color: #dcdcaa; font-weight: bold;">Net:</span> ';
                    const netParts = [];
                    netFlow.forEach((rate, resource) => {
                        const resourceDef = ResourceRegistry.get(resource);
                        const icon = resourceDef ? resourceDef.icon + ' ' : '';
                        const sign = rate >= 0 ? '+' : '';
                        const color = rate >= 0 ? '#4ec9b0' : '#f48771';
                        netParts.push(`<span style="color: ${color};">${icon}${sign}${rate.toFixed(2)}/tick</span>`);
                    });
                    flowHtml += netParts.join(', ');
                }
                
                // Depletion warnings
                let depletionHtml = '';
                const depletionWarnings = [];
                netFlow.forEach((rate, resource) => {
                    if (rate < 0) {
                        const ticks = facility.getTicksUntilDepletion(resource);
                        if (ticks !== null) {
                            const resourceDef = ResourceRegistry.get(resource);
                            const icon = resourceDef ? resourceDef.icon + ' ' : '';
                            const color = ticks <= 5 ? '#f48771' : (ticks <= 10 ? '#ce9178' : '#9cdcfe');
                            depletionWarnings.push(`<span style="color: ${color};">${icon}${ticks} ticks</span>`);
                        }
                    }
                });
                if (depletionWarnings.length > 0) {
                    depletionHtml = '<br>        <span style="color: #f48771; font-weight: bold;">‚ö†Ô∏è Depleting:</span> ' + depletionWarnings.join(', ');
                }
                
                html += `
                    <div class="facility-item">
                        <div class="facility-name">${facility.name}</div>
                        <div class="facility-status" style="color: #666; font-size: 10px;">ID: ${facility.id}</div>
                        <div class="facility-status" style="color: #ce9178;">üìç ${facility.city.name}, ${facility.city.country} (wealth ${facility.city.wealth})</div>
                        <div class="facility-status" style="color: #9cdcfe;">${sizeInfo} | üí∞ Wage: ${facility.getWagePerTick().toFixed(2)}‚Ç¨/tick</div>
                        <div class="facility-status">Recipe: ${recipeName}</div>
                        <div class="facility-status">Status: ${statusStr}</div>
                        <div class="facility-inventory">Inventory: ${inventoryStr}${contractsHtml}${flowHtml}${depletionHtml}</div>
                    </div>
                `;
            });
            
            facilitiesDiv.innerHTML = html;
        }

        window.processTick = function() {
            game.processTick();
            addMessage(`Tick ${game.getTickCount() - 1} processed`, 'info');
            updateDisplay();
        };

        window.autoTick = function() {
            const btn = document.getElementById('autoTickBtn');
            if (autoTickInterval) {
                clearInterval(autoTickInterval);
                autoTickInterval = null;
                btn.textContent = '‚ñ∂Ô∏è Auto Tick (1s)';
                addMessage('Auto tick stopped', 'info');
            } else {
                autoTickInterval = setInterval(() => {
                    window.processTick();
                }, 1000);
                btn.textContent = '‚è∏Ô∏è Stop Auto Tick';
                addMessage('Auto tick started', 'info');
            }
        };

        window.resetGame = function() {
            if (autoTickInterval) {
                clearInterval(autoTickInterval);
                autoTickInterval = null;
                document.getElementById('autoTickBtn').textContent = '‚ñ∂Ô∏è Auto Tick (1s)';
            }
            game = new GameEngine();
            alice = game.addCompany('alice', 'Alice Corp');
            bob = game.addCompany('bob', 'Bob Industries');
            window.game = game;
            window.alice = alice;
            window.bob = bob;
            document.getElementById('messageLog').innerHTML = '<div class="message info">Game reset. Ready to play!</div>';
            updateDisplay();
        };

        window.createFacility = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            const selectId = companyId + 'FacilityType';
            const cityId = companyId + 'FacilityCity';
            const facilityType = document.getElementById(selectId).value;
            const cityValue = document.getElementById(cityId).value;
            
            // Parse city from "CityName,Country" format
            const [cityName, country] = cityValue.split(',');
            const city = CityRegistry.getCity(cityName, country);
            
            if (!city) {
                addMessage(`‚ùå City not found: ${cityName}, ${country}`, 'error');
                return;
            }
            
            const facility = company.createFacility(facilityType, city);
            if (facility) {
                addMessage(`‚úÖ ${company.name} built a ${facilityType} in ${city.name} (Size ${facility.size}, ${facility.workers} workers, ${facility.getWagePerTick().toFixed(2)}‚Ç¨/tick wage)!`, 'success');
            } else {
                addMessage(`‚ùå Failed to build ${facilityType}. Not enough funds?`, 'error');
            }
            updateDisplay();
        };

        window.executeTransfer = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            
            if (company.facilities.length < 2) {
                addMessage('Need at least 2 facilities to transfer resources!', 'error');
                return;
            }

            const fromIndex = parseInt(document.getElementById(`${companyId}TransferFrom`).value);
            const toIndex = parseInt(document.getElementById(`${companyId}TransferTo`).value);
            const resource = document.getElementById(`${companyId}TransferResource`).value;
            const amount = parseInt(document.getElementById(`${companyId}TransferAmount`).value);

            const from = company.facilities[fromIndex];
            const to = company.facilities[toIndex];
            
            if (from && to) {
                const success = company.transferResource(from, to, resource, amount);
                if (success) {
                    const resourceDef = ResourceRegistry.get(resource);
                    const icon = resourceDef ? resourceDef.icon : '';
                    addMessage(`‚úÖ Transferred ${amount} ${icon} ${resource} from Facility ${fromIndex + 1} to Facility ${toIndex + 1}`, 'success');
                    toggleForm(`${companyId}Transfer`);
                } else {
                    addMessage(`‚ùå Transfer failed. Not enough resources?`, 'error');
                }
                updateDisplay();
            }
        };

        window.executeUpgrade = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            
            if (company.facilities.length === 0) {
                addMessage('No facilities to upgrade!', 'error');
                return;
            }

            const facilityIndex = parseInt(document.getElementById(`${companyId}UpgradeFacility`).value);
            const facility = company.facilities[facilityIndex];
            
            if (facility) {
                const oldSize = facility.size;
                const oldWorkers = facility.workers;
                const cost = facility.getUpgradeCost();
                
                const success = company.upgradeFacility(facility);
                if (success) {
                    addMessage(`‚úÖ Upgraded ${facility.name}! Size ${oldSize}‚Üí${facility.size}, Workers ${oldWorkers}‚Üí${facility.workers}, Cost: $${cost.toFixed(2)}`, 'success');
                    toggleForm(`${companyId}Upgrade`);
                } else {
                    addMessage(`‚ùå Upgrade failed. Not enough funds? Need $${cost.toFixed(2)}`, 'error');
                }
                updateDisplay();
            }
        };

        window.updateWorkersSlider = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            const facilityIndex = parseInt(document.getElementById(`${companyId}WorkersFacility`).value);
            const facility = company.facilities[facilityIndex];
            
            if (facility) {
                const requiredWorkers = facility.calculateRequiredWorkers();
                const maxWorkers = requiredWorkers * 10;
                const currentWorkers = facility.workers;
                const slider = document.getElementById(`${companyId}WorkersSlider`);
                
                slider.min = 0;
                slider.max = maxWorkers;
                slider.value = currentWorkers;
                
                document.getElementById(`${companyId}WorkersValue`).textContent = currentWorkers;
                document.getElementById(`${companyId}WorkersInfo`).innerHTML = 
                    `Current: ${currentWorkers} workers | Required: ${requiredWorkers} workers | Max: ${maxWorkers} workers<br>` +
                    `Current Wage: ${facility.getWagePerTick().toFixed(2)}‚Ç¨/tick`;
            }
        };

        window.updateWorkersDisplay = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            const slider = document.getElementById(`${companyId}WorkersSlider`);
            const facilityIndex = parseInt(document.getElementById(`${companyId}WorkersFacility`).value);
            const facility = company.facilities[facilityIndex];
            
            if (facility) {
                const newWorkerCount = parseInt(slider.value);
                const newWage = newWorkerCount * 1.0 * facility.city.wealth;
                
                document.getElementById(`${companyId}WorkersValue`).textContent = newWorkerCount;
                
                // Update wage preview
                const requiredWorkers = facility.calculateRequiredWorkers();
                const maxWorkers = requiredWorkers * 10;
                document.getElementById(`${companyId}WorkersInfo`).innerHTML = 
                    `Current: ${facility.workers} workers | Required: ${requiredWorkers} workers | Max: ${maxWorkers} workers<br>` +
                    `Preview Wage: ${newWage.toFixed(2)}‚Ç¨/tick (currently ${facility.getWagePerTick().toFixed(2)}‚Ç¨/tick)`;
            }
        };

        window.executeSetWorkers = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            
            if (company.facilities.length === 0) {
                addMessage('No facilities to manage workers!', 'error');
                return;
            }

            const facilityIndex = parseInt(document.getElementById(`${companyId}WorkersFacility`).value);
            const facility = company.facilities[facilityIndex];
            const newWorkerCount = parseInt(document.getElementById(`${companyId}WorkersSlider`).value);
            
            if (facility) {
                const oldWorkers = facility.workers;
                const oldWage = facility.getWagePerTick();
                
                const success = company.setFacilityWorkers(facility, newWorkerCount);
                if (success) {
                    const newWage = facility.getWagePerTick();
                    const diff = newWorkerCount - oldWorkers;
                    const action = diff > 0 ? 'Hired' : 'Fired';
                    addMessage(`‚úÖ ${action} ${Math.abs(diff)} workers at ${facility.name}! Workers: ${oldWorkers}‚Üí${facility.workers}, Wage: ${oldWage.toFixed(2)}‚Üí${newWage.toFixed(2)}‚Ç¨/tick`, 'success');
                    toggleForm(`${companyId}Workers`);
                } else {
                    const maxWorkers = facility.calculateRequiredWorkers() * 10;
                    addMessage(`‚ùå Failed to set worker count. Must be between 0 and ${maxWorkers}`, 'error');
                }
                updateDisplay();
            }
        };

        window.executeCreateSellOffer = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            
            if (company.facilities.length === 0) {
                addMessage('Need at least 1 facility to create sell offer!', 'error');
                return;
            }

            const facilityIndex = parseInt(document.getElementById(`${companyId}SellOfferFacility`).value);
            const resource = document.getElementById(`${companyId}SellOfferResource`).value;
            const amount = parseInt(document.getElementById(`${companyId}SellOfferAmount`).value);
            const price = parseFloat(document.getElementById(`${companyId}SellOfferPrice`).value);

            const facility = company.facilities[facilityIndex];
            
            if (facility) {
                const offer = company.createSellOffer(
                    game.getMarket(),
                    facility,
                    resource,
                    amount,
                    price
                );
                
                if (offer) {
                    const resourceDef = ResourceRegistry.get(resource);
                    const icon = resourceDef ? resourceDef.icon : '';
                    addMessage(`‚úÖ Created sell offer: ${amount} ${icon} ${resource}/tick @ $${price.toFixed(2)}/unit`, 'success');
                    toggleForm(`${companyId}SellOffer`);
                } else {
                    addMessage(`‚ùå Sell offer creation failed!`, 'error');
                }
                updateDisplay();
            }
        };

        window.executeCreateContract = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            const otherCompany = companyId === 'alice' ? bob : alice;
            
            if (company.facilities.length === 0) {
                addMessage('Need at least 1 facility to receive resources!', 'error');
                return;
            }

            const market = game.getMarket();
            const offerId = document.getElementById(`${companyId}ContractOffer`).value;
            const facilityIndex = parseInt(document.getElementById(`${companyId}ContractFacility`).value);
            const amount = parseInt(document.getElementById(`${companyId}ContractAmount`).value);

            const offer = market.getSellOffer(offerId);
            const facility = company.facilities[facilityIndex];
            
            if (offer && facility) {
                const contract = company.acceptSellOffer(
                    market,
                    otherCompany,
                    offer.id,
                    facility,
                    amount,
                    game.getTickCount()
                );
                
                if (contract) {
                    const resourceDef = ResourceRegistry.get(contract.resource);
                    const icon = resourceDef ? resourceDef.icon + ' ' : '';
                    addMessage(`‚úÖ Created contract: ${amount} ${icon}${contract.resource}/tick @ $${contract.pricePerUnit.toFixed(2)}/unit with ${contract.sellerName}`, 'success');
                    toggleForm(`${companyId}Contract`);
                } else {
                    addMessage(`‚ùå Contract creation failed. Can't buy from yourself or not enough available?`, 'error');
                }
                updateDisplay();
            }
        };
        
        window.executeCancel = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            const type = document.getElementById(`${companyId}CancelType`).value;
            const id = document.getElementById(`${companyId}CancelSelect`).value;
            
            if (!id) {
                addMessage('Nothing selected to cancel!', 'error');
                return;
            }
            
            const market = game.getMarket();
            let success = false;
            
            if (type === 'offer') {
                success = company.cancelSellOffer(market, id);
                if (success) {
                    addMessage(`‚úÖ Sell offer cancelled`, 'success');
                } else {
                    addMessage(`‚ùå Failed to cancel sell offer`, 'error');
                }
            } else {
                // Get the contract to find the other company
                const contract = market.getContract(id);
                if (contract) {
                    // Need to clean up both sides
                    const otherCompany = contract.sellerId === company.id ? 
                        (company.id === 'alice' ? bob : alice) : 
                        (company.id === 'alice' ? bob : alice);
                    
                    // Cancel from this company (will handle both facilities)
                    success = company.cancelContract(market, id);
                    
                    // Also remove from the other company's facility
                    if (contract.sellerId !== company.id) {
                        otherCompany.removeContractFromFacility(id, contract.sellerFacilityId);
                    } else {
                        otherCompany.removeContractFromFacility(id, contract.buyerFacilityId);
                    }
                    
                    if (success) {
                        addMessage(`‚úÖ Contract cancelled`, 'success');
                    } else {
                        addMessage(`‚ùå Failed to cancel contract`, 'error');
                    }
                } else {
                    addMessage(`‚ùå Contract not found`, 'error');
                }
            }
            
            if (success) {
                toggleForm(`${companyId}Cancel`);
            }
            updateDisplay();
        };
        
        window.executeEditOffer = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            const id = document.getElementById(`${companyId}EditSelect`).value;
            const newPrice = parseFloat(document.getElementById(`${companyId}EditOfferPrice`).value);
            const newAmount = parseInt(document.getElementById(`${companyId}EditOfferAmount`).value);
            
            if (!id) {
                addMessage('No offer selected!', 'error');
                return;
            }
            
            const success = company.updateSellOffer(game.getMarket(), id, newPrice, newAmount);
            
            if (success) {
                addMessage(`‚úÖ Sell offer updated: ${newAmount}/tick @ $${newPrice.toFixed(2)}/unit`, 'success');
                toggleForm(`${companyId}Edit`);
            } else {
                addMessage(`‚ùå Failed to update sell offer`, 'error');
            }
            updateDisplay();
        };
        
        window.executeEditContractSeller = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            const id = document.getElementById(`${companyId}EditSelect`).value;
            const newPrice = parseFloat(document.getElementById(`${companyId}EditContractSellerPrice`).value);
            
            if (!id) {
                addMessage('No contract selected!', 'error');
                return;
            }
            
            const success = company.updateContractPrice(game.getMarket(), id, newPrice);
            
            if (success) {
                addMessage(`‚úÖ Contract price updated to $${newPrice.toFixed(2)}/unit`, 'success');
                toggleForm(`${companyId}Edit`);
            } else {
                addMessage(`‚ùå Failed to update contract price`, 'error');
            }
            updateDisplay();
        };
        
        window.executeEditContractBuyer = function(companyId) {
            const company = companyId === 'alice' ? alice : bob;
            const id = document.getElementById(`${companyId}EditSelect`).value;
            const newAmount = parseInt(document.getElementById(`${companyId}EditContractBuyerAmount`).value);
            
            if (!id) {
                addMessage('No contract selected!', 'error');
                return;
            }
            
            const success = company.updateContractAmount(game.getMarket(), id, newAmount);
            
            if (success) {
                addMessage(`‚úÖ Contract amount updated to ${newAmount}/tick`, 'success');
                toggleForm(`${companyId}Edit`);
            } else {
                addMessage(`‚ùå Failed to update contract amount. Not enough in stock?`, 'error');
            }
            updateDisplay();
        };

        // Initialize display
        document.getElementById('facilitiesInfo').textContent = FacilityRegistry.displayFacilities();
        document.getElementById('resourcesInfo').textContent = ResourceRegistry.displayResources();
        
        // Display cities
        const cities = CityRegistry.getAllCities();
        const citiesText = 'üèôÔ∏è CITIES:\n' + cities.map(city => city.toString()).join('\n');
        document.getElementById('citiesInfo').textContent = citiesText;
        
        updateDisplay();
    </script>
</body>
</html>
